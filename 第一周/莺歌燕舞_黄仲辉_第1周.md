# 极客时间学习笔记（第一周）

## 20200210

Java自动内存管理技术的现状和未来

为什么在做微服务设计的时候需要DDD

如何通过软引用和弱引用提升JVM内存使用效率

## 20200211

Java中如何写一个正确的单例模式

如何设计出一款好用的分布式定时任务

复杂场景下的GIT分支工作流是怎样的

结合操作系统如何理解一行Java代码的执行

## 20200212

如何使用sed处理多行配置

数据库遇到的瓶颈都是数据库问题吗

如何合理的使用mysql的事务

## 20200213

### 一、工作记录

2月13日，下班打卡，结束忙碌的一天，今日工作：

1. 灵活用工代发需求远程会议
2. 直销银行金融开放平台迁移问题会议
3. Redis客户端改造方案沟通
4. 整理直销银行开放平台接管方案和计划
5. 安全中心对接统一外联实现在线翻译功能
6. 项目状态同步（现场工作进度，非现场到岗情况，健康状态）
7. 极客时间学习：CAT性能优化的思考

### 二、CAT性能优化的实践和分享笔记

#### 1. 背景

​	携程CAT在2014年落地后，监控数据指标指数级增长，但服务器数量只是线性平缓的增长，目前已支持**7W+客户端**，支撑消息树**8000亿消息每天**，日志量**40000亿行**每天。这背后是CAT不断优化的结果，CAT究竟是如何优化的，我们又从中能学习到什么？

#### 2. CAT服务端常见问题

- CPU满
- GC频繁

#### 3. CAT线程模型优化

​	通过HASH算法将数据分组，然后进行报表分析，CAT报表分析线程与报表数据采用了报表数据绑定，这样实现了无锁的更新数据。

​	大流量下发生了产生的数据是不均的，有些队列产生了堆积，采用的优化方案是增加队列，减少堆积。*为什么不采用优化哈希算法呢?* 后面队列继续增加后，由于队列与线程是绑定的，队列越多，线程越多，线程CPU哦i闹翻的进行上下文切换，导致了性能反而下降。

```
思考: 这充分说明了，不是线程越多就越快。
```

​	优化思路就是只增加队列，而不增加线程，采用`BIO>NIO`演进的思路进行优化。采用一个`Selector`加一个`ThreadPool`*类NIO*方式，由于报表计算是CPU密集型应用，所以线程的数量是CPU核数即可。

#### 4. 客户端计算

将部分服务端计算转移到客户端：将不变的逻辑转移到客户端，并且是服务端CPU消耗过多的计算。

> 思考：消耗客户端资源，也就是业务系统的CPU资源是否合适? 

`Transaction/Event Report`报表迁移到客户端，如何迁移？

- 客户端收集的消息树后，合并消息树
- 定时发送消息
- 统计量与消息分别采用不通的队列发送（消息是未合并的）

客户端消耗如何？由于客户端只是进行了消息的聚合，内存的消耗只需要`10M`左右，CPU占用也几乎没有。

总结：

- 对于简单、变更少的逻辑可以考虑迁移到客户端，而且客户端具备充足的上下文，客户端计算可能非常简单
- 客户端采用了批次发送的方式，服务端的性能消耗会比较平滑。

#### 5. 报表双缓冲

现象，每个小时的最初几分钟容易丢数据。CAT服务端内存使用：

- 网络过来的数据
- 当前小时的Report

但是通过网络监控，发现网络使用是平滑的，并不具备时间特征，所以，应该是第二个问题导致的。

Report的数据结构是嵌套Map：

1. 不断创建下层Map，每个Map不断resize
2. 报表要保留一个小时，所以Young GC是无法回收此类数据的
3. 报表数据最终会移动到Old区，Old不算增加

如何解决上面的问题？初始就创建两个报表，last与current，轮换使用，运行一段时间后Old区就会报保持稳定，只需要增加定时器清除一些不使用的数据。

> 1. 但这样Old区的需求肯定比之前的需求大，是空间换时间的思路。
> 2. 如何轮换的？新的数据如何覆盖原先老的数据？

总结，解决GC问题有时方法是多样的，不一定是只能调解参数，最好的方式就是尽量少分配新的内存，要考虑内存是否可以复用。

#### 6. 字符串优化

通过`jmap`分析发现`String`对象和`UTF_8$Decoder`对象占用了大量的内存空间。

**分析：**

字符串在客户端序列化为`byte[]`，在服务端反序列化为String，`byte[]->String`其实是挺消耗内存的，进行了两次byte[]数组创建和字符解码操作。CAT的`MessageTree`的三个字段：

- type/name
- status  大部分Report只关心是否成功，特殊处理，可以按需lazy转化为字符串
- data：不是所有的Report都需要，可以按需lazy转化为字符串

总结：关注大量使用的对象。

#### 7. 优化思路总结

- CPU
  - 减少额外的损失
    - 优化线程模型：上下文切换、锁竞争的消耗
  - 减少不必要的操作
    - 减少字符串构造：不必要的解码
    - 服务端计算移动到客户端
- GC
  - 减少不必要的对象创建
    - 减少创建字符串，使用已有的byte[]
    - 减少Report的重复创建、填充和resize
  - 内存复用

## 20200214

### 一、工作记录

#### 1. 中原对公业务开放银行模式交流

- 时间 `2020年2月14日 9:30 – 11:30AM`
- 目标 `分享行业相关经验，碰撞中原发展机遇，创造双方合作机会，深化合作伙伴关系`

> 话题三：开放服务平台的敏捷构建
> 分享：黄雨青、王威 ThoughtWorks 架构咨询顾问
> 时间：10:50 - 11:20

```
会议登录：ZOOM
•	Meeting ID: 102 514 119
•	Password: 045477
```

1. 安全管理中访问控制手段，有无标准？
2. 内部网关可以对内提供API复用
3. 开放服务层：平台对外开放能力，规范的API开放体系
4. 业务能力层：对内现代化
5. API规范化主要包含哪些方面？

#### 2. **Gartner GTP 服务定期沟通会议**

沟通了开放平台建设相关问题

## 交流分享

TODO 
